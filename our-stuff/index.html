<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Chat Visualizer</title>
    <style>
        :root {
            --wa-bg: #e5ddd5;
            --wa-sent: #dcf8c6;
            --wa-received: #ffffff;
            --wa-header: #075e54;
            --wa-text: #000000;
            --wa-system: #d1ebf7;
            --wa-control-bg: #ffffff;
            --wa-border: rgba(0, 0, 0, 0.1);
            --wa-highlight: #ffeb3b;
            --wa-accent: #00a884;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-blur: blur(15px);
        }

        body.dark-mode {
            --wa-bg: #0b141a;
            --wa-sent: #005c4b;
            --wa-received: #202c33;
            --wa-header: #202c33;
            --wa-text: #e9edef;
            --wa-system: #182229;
            --wa-control-bg: #202c33;
            --wa-border: rgba(255, 255, 255, 0.1);
            --wa-highlight: #bfa100;
            --wa-accent: #00a884;
            --glass-bg: rgba(32, 44, 51, 0.85);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--wa-header);
            margin: 0;
            display: flex;
            height: 100vh;
            color: var(--wa-text);
            overflow: hidden;
        }

        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
            background: var(--wa-bg);
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        #chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
        }

        /* --- Desktop Premium Sidebar (Glassmorphism) --- */
        .sidebar {
            width: 350px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--wa-border);
            border-right: 1px solid var(--wa-border);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), width 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            z-index: 20;
        }

        .sidebar.collapsed {
            width: 0;
            border: none;
            opacity: 0;
            pointer-events: none;
            transform: translateX(20px);
        }

        #timeline-section {
            width: 220px;
            border-right: 1px solid var(--wa-border);
            border-left: none;
            transform: none;
        }

        #timeline-section.collapsed {
            width: 0;
            border: none;
            transform: translateX(-20px);
        }

        /* --- Header / Search --- */
        #search-controls {
            background: var(--wa-control-bg);
            padding: 12px 24px;
            border-bottom: 1px solid var(--wa-border);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .input-group {
            background: var(--wa-bg);
            border-radius: 20px;
            padding: 6px 15px;
            display: flex;
            align-items: center;
            flex: 1;
            max-width: 400px;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .input-group:focus-within {
            border-color: var(--wa-accent);
            background: var(--wa-control-bg);
            box-shadow: 0 0 10px rgba(0, 168, 132, 0.1);
        }

        input {
            border: none;
            background: transparent;
            color: var(--wa-text);
            outline: none;
            padding: 6px;
            font-size: 14px;
            width: 100%;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background 0.2s, transform 0.1s;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .btn-icon:active {
            transform: scale(0.9);
        }

        /* --- Chat Window --- */
        #chat-window {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 30px;
            display: flex;
            flex-direction: column;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-color: var(--wa-bg);
            background-blend-mode: overlay;
            scroll-behavior: smooth;
        }

        body.dark-mode #chat-window {
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: soft-light;
            opacity: 0.9;
        }

        /* --- Bubbles & Bookmarks --- */
        .bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 12px;
            margin-bottom: 10px;
            font-size: 15px;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
            align-self: flex-start;
            background: var(--wa-received);
            color: var(--wa-text);
            transition: background 0.2s;
        }

        .bubble.sent {
            align-self: flex-end;
            background: var(--wa-sent);
            border-top-right-radius: 4px;
        }

        .bubble.received {
            border-top-left-radius: 4px;
        }

        .bubble:hover .btn-bookmark {
            opacity: 1;
            transform: translate(5px, -5px);
        }

        .btn-bookmark {
            position: absolute;
            top: 0;
            right: 0;
            transform: translate(15px, -15px);
            background: var(--wa-accent);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 5;
        }

        .sender-name {
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 4px;
            display: block;
        }

        .timestamp {
            font-size: 10px;
            opacity: 0.5;
            text-align: right;
            margin-top: 6px;
        }

        /* --- Scrollbar --- */
        #chat-window::-webkit-scrollbar {
            width: 6px;
        }

        #chat-window::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
        }

        body.dark-mode #chat-window::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- Mobile Overlays --- */
        @media (max-width: 768px) {
            #search-controls {
                flex-direction: column;
                align-items: stretch;
                padding: 12px;
            }

            .input-group {
                max-width: none;
            }

            .bubble {
                max-width: 90%;
            }

            .sidebar {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100% !important;
                height: 80vh;
                border: none;
                border-radius: 24px 24px 0 0;
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.4);
                transform: translateY(0);
                opacity: 1;
            }

            .sidebar.collapsed {
                transform: translateY(100%);
                width: 100% !important;
            }

            #timeline-section {
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                left: auto !important;
                width: 60px !important;
                height: auto;
                border-radius: 0;
                background: rgba(255, 255, 255, 0.05);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            #timeline-section.collapsed {
                transform: translateX(100%);
            }

            #timeline-section .sidebar-header {
                display: none;
            }

            #timeline-list {
                padding: 40px 0;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .timeline-month {
                width: 36px;
                height: 36px;
                padding: 0 !important;
                font-size: 10px;
                border-radius: 50%;
                background: var(--wa-accent);
                opacity: 0.9;
                margin-bottom: 6px;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            }

            .timeline-year {
                /* writing-mode: vertical-lr; */
                font-size: 12px;
                opacity: 0.4;
                padding: 10px;
            }
        }
    </style>
</head>

<body>

    <div id="app-container">
        <!-- Timeline Section -->
        <div id="timeline-section" class="sidebar collapsed">
            <div class="sidebar-header" style="background:transparent; color:inherit; padding:24px;">
                <span style="font-size:20px; font-weight:800">Timeline</span>
                <button onclick="toggleTimeline()" class="btn-icon">‚úï</button>
            </div>
            <div id="timeline-list" style="overflow-y:auto; padding:0 20px 20px;"></div>
        </div>

        <div id="chat-section">
            <div id="search-controls">
                <div class="input-group">
                    <span>üîç</span><input type="text" id="searchInput" placeholder="Search messages..."
                        oninput="runFilter()">
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="date" id="dateInput" onchange="runFilter()"
                        style="width:140px; background:var(--wa-bg); border-radius:20px; padding:6px 12px; color:var(--wa-text);">
                    <button onclick="toggleTimeline()" class="btn-icon" title="Timeline">üóìÔ∏è</button>
                    <button onclick="toggleTheme()" class="btn-icon" title="Mode">üåì</button>
                    <button onclick="toggleSidebar()" class="btn-icon" title="Bookmarks">‚≠ê</button>
                </div>
            </div>

            <div id="chat-window">
                <div style="text-align:center; padding:100px; opacity:0.3">Loading conversation...</div>
            </div>
        </div>

        <!-- Highlights Drawer -->
        <div id="highlights-section" class="sidebar collapsed">
            <div class="sidebar-header" style="background:transparent; color:inherit; padding:24px;">
                <span style="font-size:20px; font-weight:800">Bookmarks</span>
                <button onclick="toggleSidebar()" class="btn-icon">‚úï</button>
            </div>
            <div id="highlights-list" style="overflow-y:auto; padding:0 20px 20px; flex:1"></div>
            <div style="padding:24px; border-top:1px solid var(--wa-border)">
                <button onclick="exportHighlights()"
                    style="width:100%; padding:14px; border-radius:12px; background:var(--wa-accent); color:white; border:none; font-weight:700; cursor:pointer">Export
                    to JSON</button>
            </div>
        </div>
    </div>

    <script>
        let allMessages = [];
        let filteredIndices = [];
        let localHighlights = JSON.parse(localStorage.getItem('chatHighlights')) || [];
        let publicHighlights = [];
        let highlights = [];
        let isDarkMode = localStorage.getItem('chatTheme') === 'dark';

        const CHUNK_SIZE = 100;
        let firstDisplayedIndex = 0;
        let lastDisplayedIndex = 0;
        let isLoadingMore = false;
        let isSparseView = false;

        if (isDarkMode) document.body.classList.add('dark-mode');

        window.addEventListener('DOMContentLoaded', () => {
            fetch('chats.txt').then(r => r.ok ? r.text() : null).then(t => t && initApp(t));
            fetch('highlights.json').then(r => r.ok ? r.json() : []).then(data => {
                publicHighlights = data.map(h => ({ ...h, isPublic: true }));
                mergeHighlights();
            });
            setupInfiniteScroll();
        });

        function initApp(text) { processChat(text); buildTimeline(); runFilter(); }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('chatTheme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        function toggleSidebar() {
            const s = document.getElementById('highlights-section');
            s.classList.toggle('collapsed');
            if (window.innerWidth <= 768 && !s.classList.contains('collapsed')) document.getElementById('timeline-section').classList.add('collapsed');
        }

        function toggleTimeline() {
            const s = document.getElementById('timeline-section');
            s.classList.toggle('collapsed');
            if (window.innerWidth <= 768 && !s.classList.contains('collapsed')) document.getElementById('highlights-section').classList.add('collapsed');
        }

        function mergeHighlights() {
            highlights = [...publicHighlights, ...localHighlights].sort((a, b) => a.id - b.id);
            renderHighlights();
        }

        function addHighlight(msgId) {
            const note = prompt("Bookmark Title:");
            if (note) {
                const m = allMessages[msgId];
                localHighlights.push({ id: msgId, date: m.rawDate, sender: m.sender, preview: m.message.substring(0, 50) + '...', note: note });
                localStorage.setItem('chatHighlights', JSON.stringify(localHighlights));
                mergeHighlights();
            }
        }

        function renderHighlights() {
            const list = document.getElementById('highlights-list');
            list.innerHTML = highlights.length ? '' : '<div style="opacity:0.4; text-align:center; padding:40px">Bookmarked messages appear here.</div>';
            highlights.forEach((h, i) => {
                const div = document.createElement('div');
                div.style = "background:var(--wa-bg); padding:16px; border-radius:12px; margin-bottom:12px; cursor:pointer";
                div.innerHTML = `<div style="font-weight:800; color:var(--wa-accent); margin-bottom:6px">${h.note}</div><div style="font-size:12px; opacity:0.7">${h.sender}: ${h.preview}</div>`;
                div.onclick = () => { jumpToContext(h.id); if (window.innerWidth <= 768) toggleSidebar(); };
                list.appendChild(div);
            });
        }

        function jumpToContext(msgId) {
            if (document.getElementById('searchInput').value || document.getElementById('dateInput').value) resetFilters();
            const win = document.getElementById('chat-window');
            win.innerHTML = ''; isSparseView = true;
            const start = Math.max(0, msgId - 50); const end = Math.min(allMessages.length, msgId + 50);
            firstDisplayedIndex = start; lastDisplayedIndex = end;
            if (start > 0) {
                const btn = document.createElement('button'); btn.innerText = "‚Üë Load More History";
                btn.style = "margin:20px auto; padding:10px 20px; border-radius:20px; background:var(--wa-control-bg); border:1px solid var(--wa-border); cursor:pointer";
                btn.onclick = () => {
                    const h = win.scrollHeight; const s = Math.max(0, firstDisplayedIndex - CHUNK_SIZE);
                    win.prepend(createFragment(s, firstDisplayedIndex)); firstDisplayedIndex = s;
                    if (s === 0) btn.remove(); win.scrollTop = win.scrollHeight - h;
                };
                win.appendChild(btn);
            }
            win.appendChild(createFragment(start, end));
            setTimeout(() => {
                const el = document.getElementById(`msg-${msgId}`);
                if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.style.background = 'var(--wa-highlight)'; setTimeout(() => el.style.background = '', 2000); }
            }, 100);
        }

        function runFilter() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const d = document.getElementById('dateInput').value;
            filteredIndices = [];
            allMessages.forEach((m, i) => {
                if ((!d || m.isoDate === d) && (!q || m.lcContent.includes(q) || m.lcSender.includes(q))) filteredIndices.push(i);
            });
            document.body.classList.toggle('is-filtered', !!(q || d));
            const win = document.getElementById('chat-window'); win.innerHTML = '';
            lastDisplayedIndex = 0; loadNext();
        }

        function loadNext() {
            if (isLoadingMore || lastDisplayedIndex >= filteredIndices.length) return;
            isLoadingMore = true;
            const e = Math.min(lastDisplayedIndex + CHUNK_SIZE, filteredIndices.length);
            document.getElementById('chat-window').appendChild(createFragment(lastDisplayedIndex, e));
            lastDisplayedIndex = e; isLoadingMore = false;
        }

        function createFragment(s, e) {
            const f = document.createDocumentFragment();
            for (let i = s; i < e; i++) {
                const idx = filteredIndices[i]; const m = allMessages[idx];
                const d = document.createElement('div');
                d.className = `bubble ${m.isFathan ? 'sent' : 'received'}`; d.id = `msg-${idx}`;
                d.innerHTML = `
                    <div class="btn-bookmark" onclick="addHighlight(${idx}); event.stopPropagation();">‚≠ê</div>
                    <span class="sender-name" style="color:${m.color}">${m.sender}</span>
                    <div>${m.message}</div>
                    <span class="timestamp">${m.time}</span>
                `;
                d.onclick = () => jumpToContext(idx);
                f.appendChild(d);
            }
            return f;
        }

        function buildTimeline() {
            const l = document.getElementById('timeline-list'); const g = {};
            const mo = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            allMessages.forEach((m, i) => { if (m.isoDate) { const [y, mm] = m.isoDate.split('-'); if (!g[y]) g[y] = {}; if (!g[y][mm]) g[y][mm] = i; } });
            Object.keys(g).sort((a, b) => b - a).forEach(y => {
                const div = document.createElement('div'); div.className = 'timeline-year'; div.innerText = y; l.appendChild(div);
                Object.keys(g[y]).sort((a, b) => b - a).forEach(m => {
                    const md = document.createElement('div'); md.style = "padding:10px; cursor:pointer; border-radius:10px; font-weight:600; font-size:14px; margin-bottom:4px";
                    md.className = 'timeline-month'; md.innerText = mo[parseInt(m) - 1];
                    md.onclick = () => { jumpToContext(g[y][m]); if (window.innerWidth <= 768) toggleTimeline(); };
                    l.appendChild(md);
                });
            });
        }

        function setupInfiniteScroll() {
            document.getElementById('chat-window').onscroll = () => {
                const w = document.getElementById('chat-window');
                if (w.scrollTop + w.clientHeight >= w.scrollHeight - 600) loadNext();
            };
        }

        function resetFilters() { document.getElementById('searchInput').value = ''; document.getElementById('dateInput').value = ''; runFilter(); }

        function processChat(text) {
            allMessages = [];
            text.split('\n').forEach(line => {
                const m = line.match(/^(\d{1,2}\/\d{1,2}\/\d{2,4}), (\d{1,2}:\d{2}.*) - (.*?): (.*)$/);
                if (m) {
                    const [_, rd, t, s, msg] = m; const p = rd.split('/');
                    const iso = `${p[2].length == 2 ? '20' + p[2] : p[2]}-${p[0].padStart(2, '0')}-${p[1].padStart(2, '0')}`;
                    allMessages.push({ rawDate: rd, isoDate: iso, time: t.trim(), sender: s, isFathan: s.toLowerCase().includes('fathan'), message: msg, lcSender: s.toLowerCase(), lcContent: msg.toLowerCase(), color: getColor(s) });
                }
            });
        }

        function getColor(s) {
            let h = 0; for (let i = 0; i < s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
            return '#' + (h & 0x00FFFFFF).toString(16).padStart(6, '0');
        }

        function exportHighlights() {
            navigator.clipboard.writeText(JSON.stringify(highlights, null, 2)).then(() => alert("JSON copied!"));
        }
    </script>
</body>

</html>